using System.Collections;
using System.Collections.Generic;
using System;
using UnityEngine.UI;
using UnityEngine;

public class archerController : playerBase {
    private GameObject bow;
    float bowdistance;
    public float ARROW_SPEED;
    public float MAX_DASH = 2f;
    public float DASH_CD = 10f;
    private Sprite f1;
    private Sprite f2;
    private SpriteRenderer bowrender;

	// Use this for initialization

    protected override void Start ()
    {
        base.Start();
        bow = gameObject.transform.GetChild(0).gameObject;
        bowdistance = (bow.transform.position - (Vector3)rb.position).magnitude;
        interfaceplayertext.text = "You: Archer";
        f2 = Resources.Load<Sprite>("bow2");
        f1 = Resources.Load<Sprite>("bow");
        bowrender = bow.GetComponent<SpriteRenderer>();
<<<<<<< HEAD
        hit = 0;
        numarrows = 0;

        /* ABILITIES */
        GameObject[] icons = GameObject.FindGameObjectsWithTag("ability-icons");
        Array.Sort(icons,CompareIcons);

        List<cooldown> cds = new List<cooldown>();
        glcd = new cooldown("auto",GLOBAL_CD,"LMB",icons[0]);
        cds.Add(glcd);
        dashcd = new cooldown("dash",DASH_CD,"LShift",icons[1]);
        cds.Add(dashcd);

        /* SET CD TEXT */
        cds.ForEach(delegate(cooldown c){
            Text t = c.go.GetComponentInChildren(typeof(Text)) as Text;
            t.text = c.key;
        });

        /* GLOBAL CD */
        globalcd = new cooldown(GLOBAL_CD,icons);
        cds.Add(globalcd);
        StartCoroutine(cdUpdater(cds));

	}

  int CompareIcons(GameObject x, GameObject y){
    return x.name.CompareTo(y.name);
  }

    IEnumerator cdUpdater(List<cooldown> l){
      while(true){
        while(l.Count>0){
            int i = 1;
            l.ForEach(delegate(cooldown c){
                if(!c.isReady()){
                  if(!Equals(c.name,"GLOBALCD")){
                    // display square or update it at correct position
                    if(c.r==null){
                        c.r = Instantiate(Resources.Load<GameObject>("Square"),c.go.GetComponent<Transform>().position,Quaternion.identity,canvas.transform).GetComponent<SpriteRenderer>();
                    }
                    c.r.color = new Color(255,255,255,c.getRatio());
                  }
                  else{
                    if(!c.p){
                      for(int p = 0;p<c.goc.Length;p++){
                        c.addR(Instantiate(Resources.Load<GameObject>("Square"),c.goc[p].GetComponent<Transform>().position,Quaternion.identity,canvas.transform).GetComponent<SpriteRenderer>());
                      }
                      c.p = true;
                    }
                    c.rc.ForEach(delegate (SpriteRenderer r){
                      r.color = new Color(255,255,255,c.getRatio());
                    });
                  }
                }else{
                    // if square still being rendered, play flash animation then
                    // stop rendering.
                  if(!Equals(c.name,"GLOBALCD")){
                    if(c.r!=null){
                        StartCoroutine(cdFinished(c,c.r));
                        c.r = null;
                    }
                  }
                  else{
                    for(int p = 0;i<c.goc.Length;i++){
                      if(!c.p){
                        StartCoroutine(cdFinished(c,c.rc));
                        c.p = false;
                      }
                    }
                  }
                }
                i++;
            });
        yield return null;
        }
      }
=======
>>>>>>> bdammerg
    }

    protected override void shiftAbilityInit(){
        SHIFT_CD = DASH_CD;
        SHIFT_NAME = "dash";
    }

    protected override void lmbAbilityInit(){
        LMB_NAME = "arrow";
    }

    protected override void rmbAbilityInit(){
        RMB_CD = GLOBAL_CD;
        RMB_NAME = "notyetimplemented";
    }

    protected override void eAbilityInit(){
        E_CD = GLOBAL_CD;
        E_NAME = "notyetimplemented";
    }

    protected override void qAbilityInit(){
        Q_CD = GLOBAL_CD;
        Q_NAME = "notyetimplemented";
    }

    // called in fixed interval
    protected override void FixedUpdate()
    {
        base.FixedUpdate();
    }
	
<<<<<<< HEAD
	// Update is called once per frame
	void Update ()
  {
        if (Input.anyKeyDown)
        {
            SocketNetworkManager.w.SendString("{ \"msgtype\":\"keylog\", \"input\": \"" + Input.inputString + "\" }");
        }
        /* ON HIT */
        if (hit >= 0){
          Color lerpedColor = Color.Lerp(Color.white, Color.red, Mathf.Sqrt(hit)/Mathf.Sqrt(25));
          render.color = lerpedColor;
          hit--;
        }

        /* ROTATION */
        // get position of main sprite and mouse
        Vector2 pos = rb.position;
        Vector2 mouse = Camera.main.ScreenToWorldPoint(Input.mousePosition);

        // get directional vector and convert to angle
        Vector2 direction = pos - mouse;
        float angle = Mathf.Atan2(direction.y, direction.x);
=======
    // Update is called once per frame
    protected override void Update ()
    {
        base.Update();
>>>>>>> bdammerg

        // use angle to rotate bow
        bow.transform.rotation = Quaternion.AngleAxis(Mathf.Rad2Deg * angle, Vector3.forward);
        bow.transform.position = rb.position + -1 * direction.normalized * bowdistance;
    }

<<<<<<< HEAD
          if(Input.GetKey("q")){
            addArrow();
            gcd();
            break;
          }
          else if(Input.GetKey("e")){
            poisonArrow();
            gcd();
            break;
          }
          else if(Input.GetKey(KeyCode.LeftShift)){
            if(dashcd.isReady()){
              dash(direction);
              gcd();
              dashcd.setCd();
            }
            break;
          }
       
          /* ARROW */
          else if(Input.GetMouseButton(0)){
            if(!clicked){
              clicked = true;
              bowrender.sprite = f2;
              snm.sendMessage("playeranimation", "{ \"name\": \"" + "relebow" + "\" }");
            }
          }else if(clicked){ 
            bowrender.sprite = f1;
            snm.sendMessage("playeranimation", "{ \"name\": \"" + "drawbow" + "\" }");
            snm.sendMessage("spawnprojectile", "{ \"name\": \"" + "arrowOP" + "\" , \"x\": " + bow.transform.position.x + " , \"y\": " + bow.transform.position.y + ", \"dx\": " + direction.x + " , \"dy\": " + direction.y + ", \"rx\": " + bow.transform.rotation.x + ", \"ry\": " + bow.transform.rotation.y + ", \"rz\": " + bow.transform.rotation.z + ", \"rw\": " + bow.transform.rotation.w + " }");
            GameObject arrow = (GameObject)Instantiate(Resources.Load<GameObject>("arrow"),bow.transform.position,bow.transform.rotation);
            arrow.GetComponent<Rigidbody2D>().velocity = direction.normalized*ARROW_SPEED*-1;
            clicked = false;
            gcd();
            break;
          }
          break;
        }
=======
    protected override void LMBClicked(){
        bowrender.sprite = f2;
        snm.sendMessage("pa", "{ \"name\": \"" + "relebow" + "\" }");
    }
>>>>>>> bdammerg

    protected override void LMBReleased(){
        bowrender.sprite = f1;
        snm.sendMessage("pa", "{ \"name\": \"" + "drawbow" + "\" }");
        snm.sendMessage("sp", "{ \"name\": \"" + "arrowOP" + "\" , \"x\": " + bow.transform.position.x + " , \"y\": " + bow.transform.position.y + ", \"rx\": " + direction.x + ", \"ry\": " + direction.y + " }");
        GameObject arrow = (GameObject)Instantiate(Resources.Load<GameObject>("arrow"),bow.transform.position,bow.transform.rotation,GetComponent<Transform>());
        arrow.GetComponent<Rigidbody2D>().velocity = direction.normalized*ARROW_SPEED*-1;
    }

<<<<<<< HEAD
        if (Vector2.Distance(prevPos, rb.position) > 0.1f || Vector2.Angle(prevRot, direction) > Vector2.Angle(new Vector2(1, 0.1f), Vector2.right))
        {
            snm.sendMessage("playerposition", "{ \"x\": " + rb.position.x.ToString() + " , \"y\": " + rb.position.y.ToString() + ", \"rx\": " + direction.normalized.x.ToString() + ", \"ry\": " + direction.normalized.y.ToString() + " }");
            prevPos = rb.position;
            prevRot = direction;
=======
    protected override void LShiftAbility(Vector2 input){
        snm.sendMessage("pa", "{ \"name\": \"" + "dashanim" + "\" }");
        float m = input.magnitude;
        var v = input.normalized;
        if(m>MAX_DASH){ 
            m = MAX_DASH;
>>>>>>> bdammerg
        }
        v*=m;
        v = rb.position - v;
        StartCoroutine(dashAnim(rb.position,v));
    }

    protected override void QAbility(){
        Debug.Log("q ability not exist yet");
    }

<<<<<<< HEAD
  void addArrow(){
    // adds an arrow to player inventory if they don't have one.
    if(numarrows==0)
      numarrows++;
  }
  void poisonArrow(){
    // 
  }
  void dash(Vector2 direction){
    snm.sendMessage("playeranimation", "{ \"name\": \"" + "dashanim" + "\" }");
    float m = direction.magnitude;
    var v = direction.normalized;
    if(m>MAX_DASH){ 
      m = MAX_DASH;
=======
    protected override void EAbility(){
        Debug.Log("e ability not exist yet");
    }
    
    protected override void RMBAbility(){
        Debug.Log("RMB ability not exist yet");
>>>>>>> bdammerg
    }

    IEnumerator dashAnim(Vector3 opos, Vector3 mpos){
        for(int i = -10;i<=10;i++){
            Color c = Color.Lerp(Color.white, Color.green, (float)Mathf.Abs(Mathf.Abs(i)-10)/10);
            render.color = c;
            Vector3 curpos = Vector3.Lerp(opos,mpos,(float)i/10);
            rb.position = curpos;
            yield return null;
        }
    }


    // makes player invisible and unresponsive so that they could potentially be
    // revived
<<<<<<< HEAD
     void Dead()
    {
        healthbarback.transform.localScale = healthbar.transform.localScale;
        health.enabled = false;
        for (int i = 0; i < gameObject.transform.childCount; i++)
        {
            gameObject.transform.GetChild(i).gameObject.SetActive(false);
        }
        //render.enabled = false;
        this.gameObject.SetActive(false);
    }


    // simply adds a force to the list to be applied next update.
    void applyForce(Vector2 force)
    {
        forces.Add(force);
    }

    void OnCollisionEnter2D(Collision2D collision)
    {
        rb.velocity = rb.velocity * -0.5f;
    }

    // reduces player health, if its 0 then call Dead(), if not then apply
    // a knockback force given by dir
    public void TakeDamage(float dmg, Vector2 dir)
    {
        snm.sendMessage("takedamage", "{ \"dmg\": " + dmg + " }");
        var hsize = new Vector3(((health.getCurrentHP() - dmg) / health.getMaxHP()) * (healthbarsize.x), healthbarsize.y, healthbarsize.z);
        healthbar.transform.localScale = hsize;
        hit = 25;
        hbarupdatetime = 20;
        if (!health.TakeDamage(dmg))
        {
            Dead();
        }
        else
        {
            //applyForce(dir);
            knocked = 20;
        }
    }
=======
    protected override void Dead()
    {
        base.Dead();
        bowrender.enabled = false;
    }

>>>>>>> bdammerg

}

